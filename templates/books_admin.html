<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Books</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    h1 { text-align: center; }

    form {
      margin-bottom: 20px;
      text-align: center;
    }

    label[for="pdf-file"] {
      cursor: pointer;
      padding: 6px 15px;
      background: #007bff;
      color: #fff;
      border-radius: 4px;
      display: inline-block;
    }

    #pdf-file {
      display: none;
    }

    #confirm-btn {
      display: none;
      margin-left: 10px;
      padding: 6px 15px;
      cursor: pointer;
    }

    #upload-status {
      margin: 10px 0;
      font-weight: bold;
      text-align: center;
    }

    .book { position: relative; padding: 15px; background: #f4f4f4; margin-bottom: 15px; border-radius: 5px; }
    .title { font-weight: bold; font-size: 1.2em; }

    .menu-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 30px;
      right: 10px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0px 0px 6px rgba(0,0,0,0.1);
    }

    .dropdown button {
      background: none;
      border: none;
      padding: 10px;
      width: 100%;
      text-align: left;
      cursor: pointer;
    }

    .dropdown button:hover {
      background-color: #f0f0f0;
    }

    .text-preview { margin-top: 5px; color: #555; }
  </style>
</head>
<body>
  <h1>Admin Panel - Book Management</h1>

  <!-- Upload form -->
  <form id="upload-form" enctype="multipart/form-data">
    <label for="pdf-file">Upload PDF</label>
    <input type="file" id="pdf-file" name="pdf" accept="application/pdf" required />
    <button type="submit" id="confirm-btn">Confirm</button>
  </form>
  <div id="upload-status"></div>

  <!-- Book list -->
  <div id="book-list"></div>

  <script>
    const fileInput = document.getElementById("pdf-file");
    const confirmBtn = document.getElementById("confirm-btn");
    const uploadStatus = document.getElementById("upload-status");
    const uploadForm = document.getElementById("upload-form");

    // Show confirm button only when a file is selected
    fileInput.addEventListener("change", () => {
      if (fileInput.files.length > 0) {
        confirmBtn.style.display = "inline-block";
      } else {
        confirmBtn.style.display = "none";
      }
    });

    // Upload form submit handler
    uploadForm.onsubmit = async (e) => {
      e.preventDefault();

      if (!fileInput.files.length) {
        alert("Please select a PDF file.");
        return;
      }

      const formData = new FormData();
      formData.append("pdf", fileInput.files[0]);

      uploadStatus.style.color = "black";
      uploadStatus.textContent = "Uploading...";

      try {
        const res = await fetch("/upload_book", {
          method: "POST",
          body: formData,
        });

        const result = await res.json();

        if (result.status === "uploaded") {
          uploadStatus.style.color = "green";
          uploadStatus.textContent = `Uploaded: ${result.title}`;
          fileInput.value = "";
          confirmBtn.style.display = "none";
          loadBooks();
        } else {
          uploadStatus.style.color = "red";
          uploadStatus.textContent = result.error || "Upload failed";
        }
      } catch (err) {
        uploadStatus.style.color = "red";
        uploadStatus.textContent = "Upload failed: " + err.message;
      }
    };
async function loadBooks() {
  try {
    const res = await fetch("/get-books");
    const data = await res.json();

    const bookList = document.getElementById("book-list");
    bookList.innerHTML = "";

    data.books.forEach(book => {
      const bookDiv = document.createElement("div");
      bookDiv.className = "book";

      const titleDiv = document.createElement("div");
      titleDiv.className = "title";
      titleDiv.textContent = book.title;

      const previewDiv = document.createElement("div");
      previewDiv.className = "text-preview";
//      previewDiv.textContent = book.text.slice(0, 200) + (book.text.length > 200 ? "..." : "");
      previewDiv.textContent = (book.text ? book.text.slice(0, 200) : "[No text available]") + ((book.text && book.text.length > 200) ? "..." : "");


      const chunksContainer = document.createElement("div");
      chunksContainer.style.marginTop = "10px";
      chunksContainer.style.maxHeight = "200px";
      chunksContainer.style.overflowY = "auto";
      chunksContainer.style.background = "#fff";
      chunksContainer.style.border = "1px solid #ddd";
      chunksContainer.style.padding = "10px";
      chunksContainer.style.display = "none"; // hidden initially

      const showChunksBtn = document.createElement("button");
      showChunksBtn.textContent = "Show Chunks";
      showChunksBtn.style.marginTop = "10px";

      let chunksLoaded = false;
      showChunksBtn.onclick = async () => {
        if (!chunksLoaded) {
          showChunksBtn.textContent = "Loading chunks...";
          try {
            const res = await fetch(`/get-book-chunks?title=${encodeURIComponent(book.title)}`);
            const data = await res.json();

            if (data.chunks) {
              chunksContainer.innerHTML = ""; // clear previous
         data.chunks.forEach(chunk => {
  const chunkDiv = document.createElement("div");
  chunkDiv.style.borderBottom = "1px solid #eee";
  chunkDiv.style.padding = "5px 0";

  const chunkText = chunk.chunk.slice(0, 100) + (chunk.chunk.length > 100 ? "..." : "");
  const embeddingPreview = Array.isArray(chunk.embedding) 
    ? JSON.stringify(chunk.embedding).slice(0, 60) + "..." 
    : "[No embedding]";

  chunkDiv.innerHTML = `<strong>[${chunk.chunk_index}]</strong> ${chunkText} <br/>
                        <small>Embedding: ${embeddingPreview}</small>`;

  chunksContainer.appendChild(chunkDiv);
});

              chunksLoaded = true;
              showChunksBtn.textContent = "Hide Chunks";
              chunksContainer.style.display = "block";
            } else {
              chunksContainer.textContent = "Failed to load chunks";
              showChunksBtn.textContent = "Show Chunks";
            }
          } catch (err) {
            chunksContainer.textContent = "Error loading chunks: " + err.message;
            showChunksBtn.textContent = "Show Chunks";
          }
        } else {
          if (chunksContainer.style.display === "none") {
            chunksContainer.style.display = "block";
            showChunksBtn.textContent = "Hide Chunks";
          } else {
            chunksContainer.style.display = "none";
            showChunksBtn.textContent = "Show Chunks";
          }
        }
      };

      // The existing menu button and dropdown as you had:
      const menuBtn = document.createElement("button");
      menuBtn.className = "menu-button";
      menuBtn.innerHTML = "â‹®";

      const dropdown = document.createElement("div");
      dropdown.className = "dropdown";

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.onclick = async () => {
        const confirmDelete = confirm(`Are you sure you want to delete "${book.title}"?`);
        if (confirmDelete) {
          try {
            const delRes = await fetch("/delete_book", {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ title: book.title }),
            });

            const result = await delRes.json();
            if (result.status === "deleted") {
              loadBooks();
            } else {
              alert(result.error || "Error deleting book.");
            }
          } catch (err) {
            alert("Error deleting book: " + err.message);
          }
        }
      };

      dropdown.appendChild(deleteBtn);

      bookDiv.appendChild(titleDiv);
      bookDiv.appendChild(previewDiv);
      bookDiv.appendChild(showChunksBtn);
      bookDiv.appendChild(chunksContainer);
      bookDiv.appendChild(menuBtn);
      bookDiv.appendChild(dropdown);

      bookList.appendChild(bookDiv);

      // Toggle dropdown menu on menu button click
      menuBtn.onclick = () => {
        dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
      };

      // Hide dropdown when clicking outside
      document.addEventListener("click", (e) => {
        if (!bookDiv.contains(e.target)) {
          dropdown.style.display = "none";
        }
      });
    });
  } catch (err) {
    alert("Failed to load books: " + err.message);
  }
}

    // Load books on page load
    loadBooks();
  </script>
</body>
</html>
